{"version":3,"sources":["jsonp.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["!function(global, factory) {\n    'object' == typeof exports && 'undefined' != typeof module ? module.exports = factory() : 'function' == typeof define && define.amd ? define(factory) : global.jsonp = factory();\n}(this, function() {\n    \n    function toObject(val) {\n        if (null === val || void 0 === val) throw new TypeError('Object.assign cannot be called with null or undefined');\n        return Object(val);\n    }\n    function serializeParams(params) {\n        if (!params) return ''; else return Object.keys(params).map(function(item) {\n            return item + '=' + enc(params[item]);\n        }).join('&');\n    }\n    function isFunction(fn) {\n        return 'function' == typeof fn;\n    }\n    function getUrlQueryParamByName(url, name) {\n        if (!url) url = window.location.href;\n        name = name.replace(/[[]]/g, '\\\\$&');\n        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');\n        var results = regex.exec(url);\n        if (!results) return null;\n        if (!results[2]) return ''; else return decodeURIComponent(results[2].replace(/\\+/g, ' '));\n    }\n    function updateQueryStringParamByName(url, name, value) {\n        var re = new RegExp('([?&])' + name + '=.*?(&|$)', 'i');\n        var separator = -1 !== url.indexOf('?') ? '&' : '?';\n        if (url.match(re)) return url.replace(re, '$1' + name + '=' + value + '$2'); else return url + separator + name + '=' + value;\n    }\n    function jsonp$1(url, opts, cb) {\n        if (isFunction(url)) {\n            cb = url;\n            opts = {};\n        } else if (url && 'object' === (void 0 === url ? 'undefined' : _typeof(url))) {\n            cb = opts;\n            opts = url || {};\n            url = opts.url;\n        }\n        if (isFunction(opts)) {\n            cb = opts;\n            opts = {};\n        }\n        if (!opts) opts = {};\n        opts = objectAssign$1({}, defaultConfig, opts);\n        url = url || opts.url;\n        cb = cb || noop;\n        if (url && 'string' == typeof url) {\n            var urlWithParams = generateJsonpUrlWithParams(url, opts.params);\n            var datafromStore = getDataFromStore({\n                useStore: opts.useStore,\n                storeKey: urlWithParams,\n                storeCheck: opts.storeCheck,\n                storeCheckKey: opts.storeCheckKey,\n                storeSign: opts.storeSign,\n                dataCheck: opts.dataCheck\n            });\n            if (!datafromStore) {\n                opts.originalUrl = urlWithParams;\n                if (!jsonp$1.promiseClose && canUsePromise) return new Promise(function(resolve, reject) {\n                    fetchData(urlWithParams, opts, function(err, data) {\n                        if (err) {\n                            cb(err);\n                            return reject(err);\n                        }\n                        cb(null, data);\n                        resolve(data);\n                    });\n                });\n                fetchData(urlWithParams, opts, cb);\n            } else {\n                cb(null, datafromStore);\n                if (!jsonp$1.promiseClose && canUsePromise) return new Promise(function(resolve) {\n                    return resolve(datafromStore);\n                });\n            }\n        } else {\n            cb(new Error('Param url is needed!'));\n            if (!jsonp$1.promiseClose && canUsePromise) return new Promise(function(resolve, reject) {\n                return reject(new Error('Param url is needed!'));\n            });\n        }\n    }\n    function generateJsonpUrlWithParams(url, params) {\n        params = 'string' == typeof params ? params : serializeParams(params);\n        url += (~url.indexOf('?') ? '&' : '?') + params;\n        url = url.replace('?&', '?');\n        return url;\n    }\n    function fetchData(url, opts, cb) {\n        function cleanup(funcId) {\n            if (script.parentNode) script.parentNode.removeChild(script);\n            win[funcId] = noop;\n            clearTimeout(win['timer_' + funcId]);\n        }\n        var originalUrl = opts.originalUrl;\n        var charset = opts.charset;\n        var jsonpUrlQueryParam = getUrlQueryParamByName(url, opts.jsonp);\n        var funcId = ('?' === jsonpUrlQueryParam ? !1 : jsonpUrlQueryParam) || opts.name || '__jsonp' + timestamp++;\n        var gotoBackupInfo = arguments[3] || null;\n        if (jsonpUrlQueryParam) {\n            if ('?' === jsonpUrlQueryParam) url = updateQueryStringParamByName(url, opts.jsonp, encodeC(funcId));\n        } else url += ('&' === url.split('').pop() ? '' : '&') + opts.jsonp + '=' + encodeC(funcId);\n        if (!opts.cache) url += ('&' === url.split('').pop() ? '' : '&') + '_=' + new Date().getTime();\n        clearTimeout(win['timer_' + funcId]);\n        var prevFunc = win[funcId];\n        win[funcId] = function(data) {\n            prevFunc && prevFunc(data);\n            cleanup(funcId);\n            if (gotoBackupInfo) data.__$$backupCall = gotoBackupInfo;\n            if (opts.dataCheck) {\n                if (!1 !== opts.dataCheck(data)) {\n                    setDataToStore({\n                        useStore: opts.useStore,\n                        storeKey: originalUrl,\n                        data: data\n                    });\n                    return cb(null, data);\n                }\n                if (!1 === fallback(originalUrl, opts, cb)) cb(new Error('Data check error, and no fallback'));\n            } else {\n                setDataToStore({\n                    useStore: opts.useStore,\n                    storeKey: originalUrl,\n                    data: data\n                });\n                cb(null, data);\n            }\n        };\n        var script = appendScriptTagToHead({\n            url: url,\n            charset: charset\n        });\n        var timeout = null != opts.timeout ? opts.timeout : TIMEOUT_CONST;\n        win['timer_' + funcId] = setTimeout(function() {\n            cleanup(funcId);\n            if ('number' == typeof opts.retryTimes && opts.retryTimes > 0) {\n                opts.retryTimes--;\n                return fetchData(originalUrl, opts, cb);\n            }\n            if (!1 === fallback(originalUrl, opts, cb)) return cb(new Error('Timeout and no data return'));\n        }, timeout);\n    }\n    function storeCheckFn(storeData, storeCheckKey, storeSign) {\n        if (storeData && storeCheckKey && storeSign) return storeData[storeCheckKey] && storeData[storeCheckKey] === storeSign; else return !1;\n    }\n    function getDataFromStore(_ref) {\n        var useStore = _ref.useStore, storeKey = _ref.storeKey, storeCheck = _ref.storeCheck, storeCheckKey = _ref.storeCheckKey, storeSign = _ref.storeSign, dataCheck = _ref.dataCheck;\n        useStore = useStore ? store.enabled : !1;\n        if (useStore) {\n            var storeData = store.get(storeKey);\n            storeCheck = storeCheck || storeCheckFn;\n            if (storeCheck(storeData, storeCheckKey, storeSign)) if (!dataCheck || storeData && dataCheck && !1 !== dataCheck(storeData)) return storeData;\n        }\n        return null;\n    }\n    function getDataFromStoreWithoutCheck(_ref2) {\n        var useStore = _ref2.useStore, storeKey = _ref2.storeKey, dataCheck = _ref2.dataCheck;\n        useStore = useStore ? store.enabled : !1;\n        if (useStore) {\n            var storeData = store.get(storeKey);\n            if (!dataCheck || storeData && dataCheck && !1 !== dataCheck(storeData)) return storeData;\n        }\n        return null;\n    }\n    function setDataToStore(_ref3) {\n        var useStore = _ref3.useStore, storeKey = _ref3.storeKey, data = _ref3.data;\n        useStore = useStore ? store.enabled : !1;\n        if (useStore) store.set(storeKey, data);\n    }\n    function fallback(url, opts, cb) {\n        var backup = opts.backup;\n        var backupWithParams = void 0;\n        if (backup) if ('string' == typeof backup) {\n            delete opts.backup;\n            backupWithParams = generateJsonpUrlWithParams(backup, opts.params);\n            return fetchData(backupWithParams, opts, cb, {\n                backup: backup\n            });\n        } else if (Array.isArray(backup)) if (backup.length) {\n            var backupUrl = backup.shift();\n            backupWithParams = generateJsonpUrlWithParams(backupUrl, opts.params);\n            return fetchData(backupWithParams, opts, cb, {\n                backup: backupUrl\n            });\n        }\n        var dataFromStoreWithoutCheck = getDataFromStoreWithoutCheck({\n            useStore: opts.useStore,\n            storeKey: url,\n            dataCheck: opts.dataCheck\n        });\n        if (dataFromStoreWithoutCheck) {\n            cb(null, dataFromStoreWithoutCheck);\n            return !0;\n        }\n        return !1;\n    }\n    function appendScriptTagToHead(_ref4) {\n        var url = _ref4.url, charset = _ref4.charset;\n        if (doc) {\n            var script = doc.createElement('script');\n            script.type = 'text/javascript';\n            if (charset) script.charset = charset;\n            script.src = url;\n            head.appendChild(script);\n            return script;\n        }\n    }\n    var getOwnPropertySymbols = Object.getOwnPropertySymbols;\n    var hasOwnProperty = Object.prototype.hasOwnProperty;\n    var propIsEnumerable = Object.prototype.propertyIsEnumerable;\n    var objectAssign$1 = function() {\n        try {\n            if (!Object.assign) return !1;\n            var test1 = new String('abc');\n            test1[5] = 'de';\n            if ('5' === Object.getOwnPropertyNames(test1)[0]) return !1;\n            var test2 = {};\n            for (var i = 0; i < 10; i++) test2['_' + String.fromCharCode(i)] = i;\n            var order2 = Object.getOwnPropertyNames(test2).map(function(n) {\n                return test2[n];\n            });\n            if ('0123456789' !== order2.join('')) return !1;\n            var test3 = {};\n            'abcdefghijklmnopqrst'.split('').forEach(function(letter) {\n                test3[letter] = letter;\n            });\n            if ('abcdefghijklmnopqrst' !== Object.keys(Object.assign({}, test3)).join('')) return !1; else return !0;\n        } catch (err) {\n            return !1;\n        }\n    }() ? Object.assign : function(target, source) {\n        var from;\n        var to = toObject(target);\n        var symbols;\n        for (var s = 1; s < arguments.length; s++) {\n            from = Object(arguments[s]);\n            for (var key in from) if (hasOwnProperty.call(from, key)) to[key] = from[key];\n            if (getOwnPropertySymbols) {\n                symbols = getOwnPropertySymbols(from);\n                for (var i = 0; i < symbols.length; i++) if (propIsEnumerable.call(from, symbols[i])) to[symbols[i]] = from[symbols[i]];\n            }\n        }\n        return to;\n    };\n    var enc = encodeURIComponent;\n    var win$1 = 'undefined' != typeof window ? window : global;\n    var storage = win$1[\"localStorage\"];\n    var store = {\n        disabled: !1,\n        set: function(key, val) {\n            if (void 0 === val) return store.remove(key);\n            storage.setItem(key, store.serialize(val));\n            return val;\n        },\n        get: function(key, defaultVal) {\n            var val = store.deserialize(storage.getItem(key));\n            return void 0 === val ? defaultVal : val;\n        },\n        remove: function(key) {\n            storage.removeItem(key);\n        },\n        clear: function() {\n            storage.clear();\n        },\n        has: function(key) {\n            return void 0 !== store.get(key);\n        },\n        forEach: function(callback) {\n            for (var i = 0; i < storage.length; i++) {\n                var key = storage.key(i);\n                callback(key, store.get(key));\n            }\n        },\n        getAll: function() {\n            var ret = {};\n            store.forEach(function(key, val) {\n                ret[key] = val;\n            });\n            return ret;\n        },\n        serialize: function(value) {\n            return JSON.stringify(value);\n        },\n        deserialize: function(value) {\n            if ('string' == typeof value) try {\n                return JSON.parse(value);\n            } catch (err) {\n                return value || void 0;\n            }\n        }\n    };\n    try {\n        store.set(\"__store__\", \"__store__\");\n        if (\"__store__\" !== store.get(\"__store__\")) store.disabled = !0;\n        store.remove(\"__store__\");\n    } catch (err) {\n        store.disabled = !0;\n    }\n    store.enabled = !store.disabled;\n    var _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function(obj) {\n        return typeof obj;\n    } : function(obj) {\n        return obj && \"function\" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n    var win = 'undefined' != typeof window ? window : global;\n    var canUsePromise = function() {\n        return 'Promise' in win && _typeof(isFunction(Promise));\n    }();\n    var noop = function() {};\n    var encodeC = encodeURIComponent;\n    var doc = win.document;\n    var head = doc ? doc.head || doc.getElementsByTagName('head')[0] : null;\n    var TIMEOUT_CONST = 2e3;\n    var defaultConfig = {\n        timeout: TIMEOUT_CONST,\n        retryTimes: 2,\n        backup: null,\n        params: {},\n        jsonp: 'callback',\n        name: null,\n        cache: !1,\n        useStore: !1,\n        storeCheck: null,\n        storeSign: null,\n        storeCheckKey: null,\n        dataCheck: null,\n        charset: 'UTF-8'\n    };\n    var timestamp = new Date().getTime();\n    return jsonp$1;\n});\n//# sourceMappingURL=jsonp.js.map"]}